<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PU Machine Operation Parameters Calculator</title>
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.webmanifest">
    
    <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Interfoam Calc">
    <meta name="description" content="PU Machine Operation Parameters Calculator for polyurethane spraying process">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H54NMKEF6S"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-H54NMKEF6S');
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="config.js"></script>
    <script src="translations.js"></script>
    <script src="clipboard.js"></script>
    <script src="instructions.js"></script>
    <script>
      const excelData = {
        "initial_values": {
          "line_speed": 8,
          "output": 88,
          "concentration": 0,
          "ratio": 1.65
        },
        "calculation_results": {
          "O_gs": 0,
          "C_gm": 660,
          "L_mmin": null
        },
        "part2": {
          "linespeed": 7,
          "test_time": 4,
          "polyol_weight": 120,
          "iso_weight": 180,
          "polyol_rpm": 30,
          "iso_rpm": 40,
          "ratio": 1.5,
          "output_gs": 75.0,
          "consumption_gm": 642.86
        },
        "part3": {
          "new_linespeed": 8,
          "new_consumption_gm": 670,
          "new_ratio": 1.4,
          "output_gs": 89.33,
          "polyol_weight_gs": 37.22,
          "iso_weight_gs": 52.11,
          "polyol_rpm": 37.22,
          "iso_rpm": 46.32,
          "source_part2_linespeed": 7,
          "source_part2_ratio": 1.5,
          "source_part2_polyol_rpm": 30,
          "source_part2_iso_rpm": 40
        }
      };
      // Initialize language
      let currentLanguage = 'en';


      // Current language - load from localStorage or default to 'en'
      let currentLang = localStorage.getItem('puCalculatorLanguage') || 'en';

      // Google Sheets Integration Configuration
      const GOOGLE_SHEETS_CONFIG = {
        webAppUrl: (typeof CONFIG !== 'undefined' && CONFIG.GOOGLE_SHEETS_WEBAPP_URL) ? 
          CONFIG.GOOGLE_SHEETS_WEBAPP_URL : 
          // Fallback: Base64 encoded URL (basic obfuscation)
          atob('aHR0cHM6Ly9zY3JpcHQuZ29vZ2xlLmNvbS9tYWNyb3Mvcy9BS2Z5Y2J6a1BBWHF0REIxM1ZBcXBqLTZvZkxKZlJReTlZcG9vb1BhZTFJd1VzWFlWSEhsbVpsdE93MzVpa0pCMGVjRlFwRHUvZXhlYw=='),
        enabled: true
      };
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PU Machine Operation Parameters Calculator</h1>
            <div style="margin-top: 6px; margin-bottom: 6px; display: flex; align-items: center; gap: 12px; justify-content: center;">
                <button type="button" id="howToUseLink" onclick="toggleInstructions()" class="header-btn">
                </button>
                <label class="toggle-switch small-toggle">
                    <input type="checkbox" id="globalAutoClipboard">
                    <span class="slider"></span>
                </label>
                <button type="button" id="installAppBtn" onclick="installApp()" class="header-btn" style="display: none;">
                </button>
            </div>
            <div class="language-selector">
                <span class="lang-link active" onclick="switchLanguage('en')">English</span>
                <span style="opacity: 0.7;"> | </span>
                <span class="lang-link" onclick="switchLanguage('vi')">Việt</span>
                <span style="opacity: 0.7;"> | </span>
                <span class="lang-link" onclick="switchLanguage('th')">ไทย</span>
                <span style="opacity: 0.7;"> | </span>
                <span class="lang-link" onclick="switchLanguage('cn')">中文</span>
            </div>
        </div>

        <div class="main-content">
            
            <div class="part-navigation">
                <button class="nav-btn active" onclick="showPart(1)">Part 1: Basic Calculator</button>
                <button class="nav-btn" onclick="showPart(2)">Part 2: Test Data Analysis</button>
                <button class="nav-btn" onclick="showPart(3)">Part 3: Parameter Adjustment</button>
            </div>

            <!-- Part 1: Basic Calculator -->
            <div id="part1-section" class="section part1-section">
                <div class="formula-display">
                    O = C × L
                </div>

                <div class="input-group">
                    <div class="input-field">
                        <label for="lineSpeed">L - Line Speed</label>
                        <input type="number" id="lineSpeed" step="0.1" placeholder="Enter 0 to calculate" inputmode="decimal">
                        <div class="unit">Unit: m/min</div>
                    </div>
                    <div class="input-field">
                        <label for="output">O - Output</label>
                        <input type="number" id="output" step="0.01" placeholder="Enter 0 to calculate" inputmode="decimal">
                        <div class="unit">Unit: g/s</div>
                    </div>
                    <div class="input-field">
                        <label for="concentration">C - Consumption</label>
                        <input type="number" id="concentration" step="0.01" placeholder="Enter 0 to calculate" inputmode="decimal">
                        <div class="unit">Unit: g/m</div>
                    </div>
                    <div class="input-field">
                        <label for="ratio">Ratio</label>
                        <input type="number" id="ratio" value="1.65" step="0.01" inputmode="decimal">
                        <div class="unit">Iso/Pol Ratio</div>
                    </div>
                </div>

                <button type="button" class="calculate-btn" onclick="calculateBasic()">Calculate</button>
                <button type="button" class="calculate-btn" onclick="clearPart1()">Clear Data</button>

                <div id="part1-results" style="display: none;">
                    <div class="results">
                        <h3>Calculation Results</h3>
                        <div id="part1-result-content"></div>
                    </div>
                    
                    <div class="results">
                        <h3>Material Component Analysis</h3>
                        <div class="material-breakdown" id="part1MaterialBreakdown"></div>
                    </div>
                </div>
            </div>

            <!-- Part 2: Test Data Analysis -->
            <div id="part2-section" class="section part2 part2-section" style="display: none;">
                
                <div class="input-group">
                    <div class="input-field">
                        <label for="part2_linespeed">L - Test Line Speed</label>
                        <input type="number" id="part2_linespeed" step="0.1" inputmode="decimal">
                        <div class="unit">Unit: m/min</div>
                    </div>
                    <div class="input-field">
                        <label for="part2_test_time">T - Test Time</label>
                        <input type="number" id="part2_test_time" step="1" inputmode="decimal">
                        <div class="unit">Unit: seconds</div>
                    </div>
                    <div class="input-field">
                        <label for="part2_polyol">P - Polyol Weight</label>
                        <input type="number" id="part2_polyol" step="0.1" inputmode="decimal">
                        <div class="unit">Unit: g (per T seconds)</div>
                    </div>
                    <div class="input-field">
                        <label for="part2_iso">I - Isocyanate Weight</label>
                        <input type="number" id="part2_iso" step="0.1" inputmode="decimal">
                        <div class="unit">Unit: g (per T seconds)</div>
                    </div>
                    <div class="input-field">
                        <label for="part2_polyol_rpm">PR - Polyol RPM</label>
                        <input type="number" id="part2_polyol_rpm" step="0.1" inputmode="decimal">
                        <div class="unit">Unit: Hz</div>
                    </div>
                    <div class="input-field">
                        <label for="part2_iso_rpm">IR - Iso RPM</label>
                        <input type="number" id="part2_iso_rpm" step="0.1" inputmode="decimal">
                        <div class="unit">Unit: Hz</div>
                    </div>
                </div>

                <button type="button" class="calculate-btn part2" onclick="calculatePart2()">Calculate</button>
                <button type="button" class="calculate-btn part2" onclick="clearPart2()">Clear Data</button>

                <div class="results" id="part2-results" style="display: none;">
                    <h3>Part 2 Results</h3>
                    <div id="part2-result-content"></div>
                </div>
            </div>

            <!-- Part 3: Parameter Adjustment -->
            <div id="part3-section" class="section part3 part3-section" style="display: none;">
                
                <div class="input-group">
                    <div class="input-field">
                        <label for="part3_new_linespeed">Ln - New Line Speed</label>
                        <input type="number" id="part3_new_linespeed" step="0.1" inputmode="decimal">
                        <div class="unit">Unit: m/min</div>
                    </div>
                    <div class="input-field">
                        <label for="part3_new_consumption">Cn - New Consumption</label>
                        <input type="number" id="part3_new_consumption" step="1" inputmode="decimal">
                        <div class="unit">Unit: g/m</div>
                    </div>
                    <div class="input-field">
                        <label for="part3_new_ratio">Rn - New Ratio</label>
                        <input type="number" id="part3_new_ratio" step="0.01" inputmode="decimal">
                        <div class="unit">Iso/Pol Ratio</div>
                    </div>
                </div>

                <button type="button" class="calculate-btn part3" onclick="calculatePart3()">Calculate</button>
                <button type="button" class="calculate-btn part3" onclick="clearPart3()">Clear Data</button>

                <div class="results" id="part3-results" style="display: none;">
                    <h3>Part 3 Results</h3>
                    <div id="part3-result-content"></div>
                    
                    <div class="results" style="margin-top: 12px;">
                        <h3>RPM Adjustment Parameters</h3>
                        <div id="part3-rpm-content"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p onclick="toggleEmail()" style="cursor: pointer;">Binh D. Nguyen - Interfoam</p>
        </div>
    </div>

    <script>

        // PWA Install functionality
        let deferredPrompt;
        let installBtn = null;

        // Listen for the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show the install button
            installBtn = document.getElementById('installAppBtn');
            if (installBtn) {
                installBtn.style.display = 'inline-block';
            }
        });

        // Install app function
        function installApp() {
            if (!deferredPrompt) {
                // Fallback for browsers that don't support install prompt
                showInstallInstructions();
                return;
            }

            // Show the prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null;
                // Hide the install button
                if (installBtn) {
                    installBtn.style.display = 'none';
                }
            });
        }

        // Show manual install instructions for unsupported browsers
        function showInstallInstructions() {
            const instructions = {
                en: "To add this app to your home screen:\n\n• Chrome/Edge: Tap menu (⋮) → 'Add to Home screen'\n• Safari: Tap share (⤴) → 'Add to Home Screen'\n• Firefox: Tap menu (⋮) → 'Install'",
                vi: "Để thêm ứng dụng này vào màn hình chính:\n\n• Chrome/Edge: Nhấn menu (⋮) → 'Thêm vào màn hình chính'\n• Safari: Nhấn chia sẻ (⤴) → 'Thêm vào màn hình chính'\n• Firefox: Nhấn menu (⋮) → 'Cài đặt'",
                th: "เพื่อเพิ่มแอปนี้ไปยังหน้าจอหลัก:\n\n• Chrome/Edge: แตะเมนู (⋮) → 'เพิ่มไปยังหน้าจอหลัก'\n• Safari: แตะแชร์ (⤴) → 'เพิ่มไปยังหน้าจอหลัก'\n• Firefox: แตะเมนู (⋮) → 'ติดตั้ง'",
                cn: "要将此应用添加到主屏幕:\n\n• Chrome/Edge: 点击菜单 (⋮) → '添加到主屏幕'\n• Safari: 点击分享 (⤴) → '添加到主屏幕'\n• Firefox: 点击菜单 (⋮) → '安装'"
            };
            alert(instructions[currentLang] || instructions.en);
        }

        // Toggle email display function
        function toggleEmail() {
            let emailSection = document.getElementById('emailSection');
            
            if (!emailSection) {
                // Create email section if it doesn't exist
                emailSection = document.createElement('div');
                emailSection.id = 'emailSection';
                emailSection.className = 'email-info';
                emailSection.innerHTML = `
                    <div class="email-content">
                        <h3>Contact Information</h3>
                        <p><a href="mailto:binh.interfoam@gmail.com">binh.interfoam@gmail.com</a></p>
                        <p>Interfoam Vietnam JSC.</p>
                    </div>
                `;
                emailSection.style.display = 'none';
                
                // Insert after the footer
                const footer = document.querySelector('.footer');
                footer.parentNode.insertBefore(emailSection, footer.nextSibling);
            }
            
            // Toggle display
            const currentDisplay = window.getComputedStyle(emailSection).display;
            if (currentDisplay === 'none') {
                emailSection.style.display = 'block';
            } else {
                emailSection.style.display = 'none';
            }
        }

        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            // Hide the install button
            if (installBtn) {
                installBtn.style.display = 'none';
            }
        });

        // Language switching function
        function switchLanguage(lang) {
            currentLang = lang;
            
            // Save language preference to localStorage
            localStorage.setItem('puCalculatorLanguage', lang);
            
            // Update active language selector
            document.querySelectorAll('.lang-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update all translatable elements
            updateTranslations();
        }
        
        function updateTranslations() {
            const t = translations[currentLang];
            if (!t) {
                console.error('No translations found for language:', currentLang);
                return;
            }
            
            // Update title
            const titleElement = document.querySelector('h1');
            if (titleElement) titleElement.textContent = t.title;
            
            // Update how to use button
            const howToUseBtn = document.querySelector('#howToUseLink');
            if (howToUseBtn) howToUseBtn.textContent = t.howToUse;
            
            // Update add to home screen button
            const installBtn = document.querySelector('#installAppBtn');
            if (installBtn) {
                installBtn.textContent = t.addToHomeScreen;
            }
            
            // Update navigation buttons
            const navBtns = document.querySelectorAll('.nav-btn');
            if (navBtns[0]) navBtns[0].textContent = t.part1;
            if (navBtns[1]) navBtns[1].textContent = t.part2;
            if (navBtns[2]) navBtns[2].textContent = t.part3;
            
            // Update Part 1
            const part1Title = document.querySelector('#part1-section h2');
            const part1Formula = document.querySelector('#part1-section p');
            const lineSpeedLabel = document.querySelector('label[for="lineSpeed"]');
            const outputLabel = document.querySelector('label[for="output"]');
            const concentrationLabel = document.querySelector('label[for="concentration"]');
            const ratioLabel = document.querySelector('label[for="ratio"]');
            
            if (part1Title) part1Title.textContent = t.part1;
            if (part1Formula) part1Formula.textContent = t.formula_desc;
            if (lineSpeedLabel) lineSpeedLabel.textContent = t.lineSpeed;
            if (outputLabel) outputLabel.textContent = t.output;
            if (concentrationLabel) concentrationLabel.textContent = t.consumption;
            if (ratioLabel) ratioLabel.textContent = t.ratio;
            
            // Update units
            const units = document.querySelectorAll('.unit');
            if (units[0]) units[0].textContent = t.unitMMin;
            if (units[1]) units[1].textContent = t.unitGs;
            if (units[2]) units[2].textContent = t.unitGm;
            if (units[3]) units[3].textContent = t.isoPolRatio;
            
            // Update placeholders
            document.querySelectorAll('input[placeholder]').forEach(input => {
                input.placeholder = t.placeholder;
            });
            
            // Update buttons
            const part1CalcBtn = document.querySelector('#part1-section .calculate-btn:first-of-type');
            const part1ClearBtn = document.querySelector('#part1-section .calculate-btn:last-of-type');
            if (part1CalcBtn) part1CalcBtn.textContent = t.calculate;
            if (part1ClearBtn) part1ClearBtn.textContent = t.clearData;
            
            // Update Part 2
            const part2Title = document.querySelector('#part2-section h2');
            const part2Desc = document.querySelector('#part2-section > p');
            const part2LineSpeedLabel = document.querySelector('label[for="part2_linespeed"]');
            const part2TestTimeLabel = document.querySelector('label[for="part2_test_time"]');
            const part2PolyolLabel = document.querySelector('label[for="part2_polyol"]');
            const part2IsoLabel = document.querySelector('label[for="part2_iso"]');
            const part2PolyolRpmLabel = document.querySelector('label[for="part2_polyol_rpm"]');
            const part2IsoRpmLabel = document.querySelector('label[for="part2_iso_rpm"]');
            
            if (part2Title) part2Title.textContent = t.part2;
            if (part2Desc) part2Desc.textContent = t.testDataDesc;
            if (part2LineSpeedLabel) part2LineSpeedLabel.textContent = t.testLineSpeed;
            if (part2TestTimeLabel) part2TestTimeLabel.textContent = t.testTime;
            if (part2PolyolLabel) part2PolyolLabel.textContent = t.polyolWeight;
            if (part2IsoLabel) part2IsoLabel.textContent = t.isocyanateWeight;
            if (part2PolyolRpmLabel) part2PolyolRpmLabel.textContent = t.polyolRPM;
            if (part2IsoRpmLabel) part2IsoRpmLabel.textContent = t.isoRPM;
            
            // Update Part 2 units
            const part2Units = document.querySelectorAll('#part2-section .unit');
            if (part2Units[0]) part2Units[0].textContent = t.unitMMin;
            if (part2Units[1]) part2Units[1].textContent = t.unitSeconds;
            if (part2Units[2]) part2Units[2].textContent = t.unitGPerT;
            if (part2Units[3]) part2Units[3].textContent = t.unitGPerT;
            if (part2Units[4]) part2Units[4].textContent = t.unitHz;
            if (part2Units[5]) part2Units[5].textContent = t.unitHz;
            
            // Update Part 2 buttons
            const part2CalcBtn = document.querySelector('#part2-section .calculate-btn:first-of-type');
            const part2ClearBtn = document.querySelector('#part2-section .calculate-btn:last-of-type');
            if (part2CalcBtn) part2CalcBtn.textContent = t.calculate;
            if (part2ClearBtn) part2ClearBtn.textContent = t.clearData;
            
            // Update Part 3
            const part3Title = document.querySelector('#part3-section h2');
            const part3Desc = document.querySelector('#part3-section > p');
            const part3LineSpeedLabel = document.querySelector('label[for="part3_new_linespeed"]');
            const part3ConsumptionLabel = document.querySelector('label[for="part3_new_consumption"]');
            const part3RatioLabel = document.querySelector('label[for="part3_new_ratio"]');
            
            if (part3Title) part3Title.textContent = t.part3;
            if (part3Desc) part3Desc.textContent = t.parameterDesc;
            if (part3LineSpeedLabel) part3LineSpeedLabel.textContent = t.newLineSpeed;
            if (part3ConsumptionLabel) part3ConsumptionLabel.textContent = t.newConsumption;
            if (part3RatioLabel) part3RatioLabel.textContent = t.newRatio;
            
            // Update Part 3 units
            const part3Units = document.querySelectorAll('#part3-section .unit');
            if (part3Units[0]) part3Units[0].textContent = t.unitMMin;
            if (part3Units[1]) part3Units[1].textContent = t.unitGm;
            if (part3Units[2]) part3Units[2].textContent = t.isoPolRatio;
            
            // Update Part 3 buttons
            const part3CalcBtn = document.querySelector('#part3-section .calculate-btn:first-of-type');
            const part3ClearBtn = document.querySelector('#part3-section .calculate-btn:last-of-type');
            if (part3CalcBtn) part3CalcBtn.textContent = t.calculate;
            if (part3ClearBtn) part3ClearBtn.textContent = t.clearData;
            
            // Update result headings
            const resultHeadings = document.querySelectorAll('h3');
            if (resultHeadings[0]) resultHeadings[0].textContent = t.calculationResults;
            if (resultHeadings[1]) resultHeadings[1].textContent = t.materialAnalysis;
            if (resultHeadings[2]) resultHeadings[2].textContent = t.part2Results;
            if (resultHeadings[3]) resultHeadings[3].textContent = t.part3Results;
            if (resultHeadings[4]) resultHeadings[4].textContent = t.rpmAdjustment;
            
            // Update clipboard toggle labels
            document.querySelectorAll('.autoClipboard-label').forEach(label => {
                label.textContent = t.autoClipboard;
            });
            
            // Update instructions content using external function
            if (typeof updateInstructionsTranslations !== 'undefined') {
                // Always call the function - it will check if instructions exist
                updateInstructionsTranslations(currentLang);
            }
        }

        // Navigation between parts
        function showPart(partNumber) {
            // Hide all sections
            document.getElementById('part1-section').style.display = 'none';
            document.getElementById('part2-section').style.display = 'none';
            document.getElementById('part3-section').style.display = 'none';
            
            // Remove active class and part classes from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'part2', 'part3');
            });
            
            // Show selected section and activate nav button with appropriate part class
            document.getElementById(`part${partNumber}-section`).style.display = 'block';
            const activeBtn = document.querySelectorAll('.nav-btn')[partNumber - 1];
            activeBtn.classList.add('active');
            if (partNumber === 2) {
                activeBtn.classList.add('part2');
            } else if (partNumber === 3) {
                activeBtn.classList.add('part3');
            }
        }

        // Loading state functions
        function showLoading(buttonElement) {
            buttonElement.disabled = true;
            buttonElement.style.opacity = '0.7';
            const originalText = buttonElement.textContent;
            buttonElement.dataset.originalText = originalText;
            buttonElement.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 8px;"><div class="spinner"></div>Calculating...</span>';
        }
        
        function hideLoading(buttonElement) {
            buttonElement.disabled = false;
            buttonElement.style.opacity = '1';
            buttonElement.textContent = buttonElement.dataset.originalText || 'Calculate';
        }

        // Part 1 Functions
        function calculateBasic() {
            const calculateButton = event.target;
            showLoading(calculateButton);
            const lineSpeed = parseFloat(document.getElementById('lineSpeed').value) || 0;
            const output = parseFloat(document.getElementById('output').value) || 0;
            const concentration = parseFloat(document.getElementById('concentration').value) || 0;
            const ratioValue = document.getElementById('ratio').value;
            const ratio = parseFloat(ratioValue);
            
            // Validate ratio is mandatory and not zero
            if (!ratioValue || isNaN(ratio) || ratio <= 0) {
                hideLoading(calculateButton);
                showError(translations[currentLang].errorRatioRequired);
                return;
            }

            const resultContainer = document.getElementById('part1-result-content');
            resultContainer.innerHTML = '';

            let calculationType = '';

            if (lineSpeed === 0 && output > 0 && concentration > 0) {
                calculationType = 'lineSpeed';
                const outputInGmin = output * 60;
                const calculatedL = outputInGmin / concentration;
                displayResult('part1-result-content', translations[currentLang].lineSpeed, calculatedL.toFixed(1), 'm/min');
                calculatePart1MaterialBreakdown(output, ratio);
                document.getElementById('part1-results').style.display = 'block';
                
            } else if (output === 0 && lineSpeed > 0 && concentration > 0) {
                calculationType = 'output';
                const calculatedO_gmin = concentration * lineSpeed;
                const calculatedO_gs = calculatedO_gmin / 60;
                
                displayResult('part1-result-content', translations[currentLang].output, calculatedO_gs.toFixed(2), 'g/s');
                calculatePart1MaterialBreakdown(calculatedO_gs, ratio);
                document.getElementById('part1-results').style.display = 'block';
                
            } else if (concentration === 0 && lineSpeed > 0 && output > 0) {
                calculationType = 'consumption';
                const outputInGmin = output * 60;
                const calculatedC = outputInGmin / lineSpeed;
                displayResult('part1-result-content', translations[currentLang].consumption, calculatedC.toFixed(2), 'g/m');
                calculatePart1MaterialBreakdown(output, ratio);
                document.getElementById('part1-results').style.display = 'block';
                
            } else {
                hideLoading(calculateButton);
                showError(translations[currentLang].errorPart1);
                return;
            }

            // Generate and copy clipboard text if global toggle is enabled
            if (document.getElementById('globalAutoClipboard').checked) {
                const clipboardText = generatePart1ClipboardText(lineSpeed, output, concentration, ratio, currentLang, calculationType);
                copyToClipboard(clipboardText);
            }

            // Send data to Google Sheets
            const googleSheetsData = {
                part: 'part1',
                sheetName: 'Part1',
                language: currentLang,
                inputs: {
                    lineSpeed: lineSpeed,
                    output: output,
                    concentration: concentration,
                    ratio: ratio
                },
                results: {},
                materialBreakdown: {}
            };

            // Add results based on calculation type
            if (lineSpeed === 0) {
                const calculatedL = (output * 60) / concentration;
                googleSheetsData.results = {
                    calculatedType: 'Line Speed',
                    calculatedValue: calculatedL.toFixed(1),
                    calculatedUnit: 'm/min'
                };
            } else if (output === 0) {
                const calculatedO_gs = (concentration * lineSpeed) / 60;
                googleSheetsData.results = {
                    calculatedType: 'Output',
                    calculatedValue: calculatedO_gs.toFixed(2),
                    calculatedUnit: 'g/s'
                };
            } else if (concentration === 0) {
                const calculatedC = (output * 60) / lineSpeed;
                googleSheetsData.results = {
                    calculatedType: 'Consumption',
                    calculatedValue: calculatedC.toFixed(2),
                    calculatedUnit: 'g/m'
                };
            }

            // Add material breakdown
            const finalOutput = output === 0 ? (concentration * lineSpeed) / 60 : output;
            const totalRatio = 1 + ratio;
            const polAmount = finalOutput / totalRatio;
            const isoAmount = finalOutput * ratio / totalRatio;
            
            googleSheetsData.materialBreakdown = {
                '1s': { pol: polAmount.toFixed(1), iso: isoAmount.toFixed(1), total: (polAmount + isoAmount).toFixed(1) },
                '4s': { pol: (polAmount * 4).toFixed(1), iso: (isoAmount * 4).toFixed(1), total: ((polAmount + isoAmount) * 4).toFixed(1) },
                '6s': { pol: (polAmount * 6).toFixed(1), iso: (isoAmount * 6).toFixed(1), total: ((polAmount + isoAmount) * 6).toFixed(1) }
            };

            sendDataToGoogleSheets(googleSheetsData);
            
            // Hide loading state after a short delay
            setTimeout(() => hideLoading(calculateButton), 300);
        }


        function calculatePart1MaterialBreakdown(output, ratio) {
            const container = document.getElementById('part1MaterialBreakdown');
            container.innerHTML = '';

            const totalRatio = 1 + ratio;
            const polAmount = output / totalRatio;
            const isoAmount = output * ratio / totalRatio;

            const multipliers = [1, 4, 6];
            
            multipliers.forEach(multiplier => {
                const pol = polAmount * multiplier;
                const iso = isoAmount * multiplier;
                const sum = pol + iso;
                const timeLabel = `${multiplier}s`;

                // Create a grouped display matching Part 3 format
                const timeGroup = document.createElement('div');
                timeGroup.className = 'result-item';
                timeGroup.style.flexDirection = 'column';
                timeGroup.style.alignItems = 'flex-start';
                timeGroup.innerHTML = `
                    <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px;">
                        <span class="result-label" style="font-weight: 700;">${timeLabel} ${translations[currentLang].total}</span>
                        <span class="result-value">${sum.toFixed(1)}g</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; width: 100%; font-size: 1.1em; opacity: 0.8;">
                        <span>Polyol: ${pol.toFixed(1)}g</span>
                        <span>Iso: ${iso.toFixed(1)}g</span>
                    </div>
                `;
                container.appendChild(timeGroup);
            });
        }

        function clearPart1() {
            document.getElementById('lineSpeed').value = '';
            document.getElementById('output').value = '';
            document.getElementById('concentration').value = '';
            document.getElementById('ratio').value = '1.65';
            document.getElementById('part1-result-content').innerHTML = '';
            document.getElementById('part1MaterialBreakdown').innerHTML = '';
            document.getElementById('part1-results').style.display = 'none';
        }

        // Part 2 Functions
        function calculatePart2() {
            const calculateButton = event.target;
            showLoading(calculateButton);
            const linespeed = parseFloat(document.getElementById('part2_linespeed').value) || 0;
            const testTime = parseFloat(document.getElementById('part2_test_time').value) || 0;
            const polyolWeight = parseFloat(document.getElementById('part2_polyol').value) || 0;
            const isoWeight = parseFloat(document.getElementById('part2_iso').value) || 0;
            const polyolRpm = parseFloat(document.getElementById('part2_polyol_rpm').value) || 0;
            const isoRpm = parseFloat(document.getElementById('part2_iso_rpm').value) || 0;

            if (linespeed <= 0 || testTime <= 0 || polyolWeight <= 0 || isoWeight <= 0) {
                hideLoading(calculateButton);
                showError(translations[currentLang].errorMandatory);
                return;
            }

            // Check if RPM values are missing and show warning
            if (polyolRpm <= 0 || isoRpm <= 0) {
                showError(translations[currentLang].errorRPMWarning);
            }

            const ratio = isoWeight / polyolWeight;
            const totalWeight = polyolWeight + isoWeight;
            const outputGs = totalWeight / testTime;
            const consumptionGM = (outputGs * 60) / linespeed;

            const resultContainer = document.getElementById('part2-result-content');
            resultContainer.innerHTML = '';

            displayResult('part2-result-content', translations[currentLang].ratio, ratio.toFixed(2), '');
            displayResult('part2-result-content', translations[currentLang].output, outputGs.toFixed(2), 'g/s');
            displayResult('part2-result-content', translations[currentLang].consumption, consumptionGM.toFixed(2), 'g/m');

            document.getElementById('part2-results').style.display = 'block';

            // Store Part 2 results for Part 3 to use
            window.part2Results = {
                ratio: ratio,
                outputGs: outputGs,
                consumptionGM: consumptionGM,
                polyolRpm: polyolRpm,
                isoRpm: isoRpm,
                linespeed: linespeed
            };

            // Auto-populate Part 3 inputs with Part 2 results
            document.getElementById('part3_new_linespeed').value = linespeed;
            document.getElementById('part3_new_consumption').value = consumptionGM.toFixed(2);
            document.getElementById('part3_new_ratio').value = ratio.toFixed(2);

            // Generate and copy clipboard text if global toggle is enabled
            if (document.getElementById('globalAutoClipboard').checked) {
                const clipboardText = generatePart2ClipboardText(linespeed, testTime, polyolWeight, isoWeight, polyolRpm, isoRpm, ratio, outputGs, consumptionGM, currentLang);
                copyToClipboard(clipboardText);
            }

            // Send data to Google Sheets
            const googleSheetsData = {
                part: 'part2',
                sheetName: 'Part2',
                language: currentLang,
                inputs: {
                    linespeed: linespeed,
                    testTime: testTime,
                    polyolWeight: polyolWeight,
                    isoWeight: isoWeight,
                    polyolRpm: polyolRpm,
                    isoRpm: isoRpm
                },
                results: {
                    ratio: ratio.toFixed(2),
                    outputGs: outputGs.toFixed(2),
                    consumptionGM: consumptionGM.toFixed(2)
                }
            };

            sendDataToGoogleSheets(googleSheetsData);
            
            // Hide loading state after a short delay
            setTimeout(() => hideLoading(calculateButton), 300);
        }

        function clearPart2() {
            document.getElementById('part2_linespeed').value = '';
            document.getElementById('part2_test_time').value = '';
            document.getElementById('part2_polyol').value = '';
            document.getElementById('part2_iso').value = '';
            document.getElementById('part2_polyol_rpm').value = '';
            document.getElementById('part2_iso_rpm').value = '';
            document.getElementById('part2-result-content').innerHTML = '';
            document.getElementById('part2-results').style.display = 'none';
        }

        // Part 3 Functions
        function calculatePart3() {
            const calculateButton = event.target;
            showLoading(calculateButton);
            const newLinespeed = parseFloat(document.getElementById('part3_new_linespeed').value) || 0;
            const newConsumption = parseFloat(document.getElementById('part3_new_consumption').value) || 0;
            const newRatio = parseFloat(document.getElementById('part3_new_ratio').value) || 0;

            if (newLinespeed <= 0 || newConsumption <= 0 || newRatio <= 0) {
                hideLoading(calculateButton);
                showError(translations[currentLang].errorPart3);
                return;
            }

            // Calculate new output based on new parameters
            const newOutputGs = (newConsumption * newLinespeed) / 60; // Convert g/m to g/s

            // Calculate component weights based on new ratio
            const totalRatio = 1 + newRatio;
            const polyolWeightGs = newOutputGs / totalRatio;
            const isoWeightGs = polyolWeightGs * newRatio;

            // Calculate RPM adjustments based on Part 2 data
            let polyolRpm = 0;
            let isoRpm = 0;

            if (window.part2Results) {
                // Use Part 2 RPM as baseline and scale based on weight changes
                // Formula: part3 polyol RPM = (Part2 input polyol RPM) * ((part3 polyol weight per second) / (part2 polyol weight per second))
                // Formula: part3 iso RPM = (Part2 input iso RPM) * ((part3 iso weight per second) / (part2 iso weight per second))
                const part2PolyolWeightPerSecond = window.part2Results.outputGs / (1 + window.part2Results.ratio);
                const part2IsoWeightPerSecond = window.part2Results.outputGs * window.part2Results.ratio / (1 + window.part2Results.ratio);
                
                polyolRpm = (window.part2Results.polyolRpm * polyolWeightGs) / part2PolyolWeightPerSecond;
                isoRpm = (window.part2Results.isoRpm * isoWeightGs) / part2IsoWeightPerSecond;
            } else {
                // Use Excel data as fallback
                polyolRpm = excelData.part3.polyol_rpm;
                isoRpm = excelData.part3.iso_rpm;
            }

            const resultContainer = document.getElementById('part3-result-content');
            resultContainer.innerHTML = '';

            // Main output results
            displayResult('part3-result-content', translations[currentLang].totalOutput, newOutputGs.toFixed(2), 'g/s');
            
            // Component breakdown section
            const componentHeader = document.createElement('div');
            componentHeader.className = 'result-section-header';
            componentHeader.innerHTML = `<h4 style="color: #2c3e50; margin: 15px 0 10px 0; font-size: 1.1em;">${translations[currentLang].componentWeights}</h4>`;
            resultContainer.appendChild(componentHeader);
            
            displayResult('part3-result-content', translations[currentLang].polyolWeight, polyolWeightGs.toFixed(2), 'g/s');
            displayResult('part3-result-content', translations[currentLang].isocyanateWeight, isoWeightGs.toFixed(2), 'g/s');

            // Time-based breakdown section
            const timeHeader = document.createElement('div');
            timeHeader.className = 'result-section-header';
            timeHeader.innerHTML = `<h4 style="color: #2c3e50; margin: 15px 0 10px 0; font-size: 1.1em;">${translations[currentLang].timeBasedBreakdown}</h4>`;
            resultContainer.appendChild(timeHeader);
            
            const timeMultipliers = [4, 6];
            let timeBreakdownText = "";
            timeMultipliers.forEach(multiplier => {
                const pol = polyolWeightGs * multiplier;
                const iso = isoWeightGs * multiplier;
                const total = pol + iso;
                const timeLabel = `${multiplier}s`;
                
                timeBreakdownText += `${timeLabel} Total: ${total.toFixed(1)}g (Polyol: ${pol.toFixed(1)}g, Iso: ${iso.toFixed(1)}g)\n`;
                
                // Create a grouped display for each time period
                const timeGroup = document.createElement('div');
                timeGroup.className = 'result-item';
                timeGroup.style.flexDirection = 'column';
                timeGroup.style.alignItems = 'flex-start';
                timeGroup.innerHTML = `
                    <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px;">
                        <span class="result-label" style="font-weight: 700;">${timeLabel} ${translations[currentLang].total}</span>
                        <span class="result-value">${total.toFixed(1)}g</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; width: 100%; font-size: 1.1em; opacity: 0.8;">
                        <span>Polyol: ${pol.toFixed(1)}g</span>
                        <span>Iso: ${iso.toFixed(1)}g</span>
                    </div>
                `;
                resultContainer.appendChild(timeGroup);
            });

            const rpmContainer = document.getElementById('part3-rpm-content');
            rpmContainer.innerHTML = '';

            displayResult('part3-rpm-content', translations[currentLang].polyolRPM, polyolRpm.toFixed(2), 'Hz');
            displayResult('part3-rpm-content', translations[currentLang].isoRPM, isoRpm.toFixed(2), 'Hz');

            document.getElementById('part3-results').style.display = 'block';

            // Generate and copy clipboard text if global toggle is enabled
            if (document.getElementById('globalAutoClipboard').checked) {
                const clipboardText = generatePart3ClipboardText(newLinespeed, newConsumption, newRatio, newOutputGs, polyolWeightGs, isoWeightGs, timeBreakdownText, polyolRpm, isoRpm, currentLang);
                copyToClipboard(clipboardText);
            }

            // Send data to Google Sheets
            const googleSheetsData = {
                part: 'part3',
                sheetName: 'Part3',
                language: currentLang,
                inputs: {
                    newLinespeed: newLinespeed,
                    newConsumption: newConsumption,
                    newRatio: newRatio
                },
                results: {
                    newOutputGs: newOutputGs.toFixed(2),
                    polyolWeightGs: polyolWeightGs.toFixed(2),
                    isoWeightGs: isoWeightGs.toFixed(2),
                    polyolRpm: polyolRpm.toFixed(2),
                    isoRpm: isoRpm.toFixed(2),
                    timeBreakdown: {
                        '4s': {
                            total: (newOutputGs * 4).toFixed(1),
                            polyol: (polyolWeightGs * 4).toFixed(1),
                            iso: (isoWeightGs * 4).toFixed(1)
                        },
                        '6s': {
                            total: (newOutputGs * 6).toFixed(1),
                            polyol: (polyolWeightGs * 6).toFixed(1),
                            iso: (isoWeightGs * 6).toFixed(1)
                        }
                    }
                }
            };

            sendDataToGoogleSheets(googleSheetsData);
            
            // Hide loading state after a short delay
            setTimeout(() => hideLoading(calculateButton), 300);
        }

        function clearPart3() {
            document.getElementById('part3_new_linespeed').value = '';
            document.getElementById('part3_new_consumption').value = '';
            document.getElementById('part3_new_ratio').value = '';
            document.getElementById('part3-result-content').innerHTML = '';
            document.getElementById('part3-rpm-content').innerHTML = '';
            document.getElementById('part3-results').style.display = 'none';
        }

        // Utility Functions
        function displayResult(containerId, label, value, unit) {
            const container = document.getElementById(containerId);
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.innerHTML = `
                <span class="result-label">${label}</span>
                <span class="result-value">${value} ${unit}</span>
            `;
            container.appendChild(resultItem);
        }

        // Google Sheets Integration Functions
        async function sendDataToGoogleSheets(data) {
            if (!GOOGLE_SHEETS_CONFIG.enabled || GOOGLE_SHEETS_CONFIG.webAppUrl === 'REPLACE_WITH_YOUR_WEBAPP_URL') {
                console.log('Google Sheets integration disabled or URL not configured');
                return;
            }

            try {
                const response = await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors', // Important for Google Apps Script
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                // Note: no-cors mode means we can't read the response, but the request will be sent
                console.log('Data sent to Google Sheets successfully');
                
            } catch (error) {
                console.error('Failed to send data to Google Sheets:', error);
            }
        }


        // Input validation functions
        function validateInput(inputElement, min = null, max = null, required = true) {
            const value = parseFloat(inputElement.value);
            const fieldContainer = inputElement.closest('.input-field');
            
            // Remove existing validation messages
            const existingError = fieldContainer.querySelector('.validation-error');
            if (existingError) {
                existingError.remove();
            }
            
            fieldContainer.classList.remove('error', 'success');
            
            if (required && (!inputElement.value || inputElement.value.trim() === '')) {
                if (inputElement.value !== '0') {
                    showFieldError(fieldContainer, translations[currentLang].errorRequired || 'This field is required');
                    return false;
                }
            }
            
            if (inputElement.value && isNaN(value)) {
                showFieldError(fieldContainer, translations[currentLang].errorInvalidNumber || 'Please enter a valid number');
                return false;
            }
            
            if (min !== null && value < min && value !== 0) {
                showFieldError(fieldContainer, `${translations[currentLang].errorMinValue || 'Minimum value is'} ${min}`);
                return false;
            }
            
            if (max !== null && value > max) {
                showFieldError(fieldContainer, `${translations[currentLang].errorMaxValue || 'Maximum value is'} ${max}`);
                return false;
            }
            
            // Show success state
            fieldContainer.classList.add('success');
            return true;
        }
        
        function showFieldError(fieldContainer, message) {
            fieldContainer.classList.add('error');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error';
            errorDiv.textContent = message;
            fieldContainer.appendChild(errorDiv);
        }
        
        function addInputValidation() {
            const inputIds = [
                'lineSpeed', 'output', 'concentration', 'ratio'
            ];
            
            inputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('blur', function() {
                        // Set validation rules based on input type
                        let min = null, max = null, required = true;
                        
                        if (id === 'ratio' || id.includes('_ratio')) {
                            min = 0.1;
                            max = 5; // Ratio: 0.1-5
                        } else if (id === 'lineSpeed') {
                            // Line Speed: 4-20 m/min (allow 0 for calculation)
                            min = 4;
                            max = 20;
                            required = false;
                        } else if (id === 'output') {
                            // Output: 10-1000 g/s (allow 0 for calculation)  
                            min = 10;
                            max = 1000;
                            required = false;
                        } else if (id === 'concentration') {
                            // Consumption: 1-10000 g/m (allow 0 for calculation)
                            min = 1;
                            max = 10000;
                            required = false;
                        } else {
                            min = 0;
                            max = 10000;
                        }
                        
                        validateInput(this, min, max, required);
                    });
                    
                    // Real-time validation on input
                    element.addEventListener('input', function() {
                        const fieldContainer = this.closest('.input-field');
                        fieldContainer.classList.remove('error', 'success');
                        const existingError = fieldContainer.querySelector('.validation-error');
                        if (existingError) {
                            existingError.remove();
                        }
                    });
                }
            });
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'warning';
            errorDiv.innerHTML = message;
            document.querySelector('.main-content').insertBefore(errorDiv, document.querySelector('.part-navigation').nextSibling);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Initialize language on page load
        function initializeLanguage() {
            // Set the active language selector based on saved preference
            document.querySelectorAll('.lang-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Find and activate the correct language link
            const langLinks = document.querySelectorAll('.lang-link');
            const langMap = {
                'en': 0,
                'vi': 1,
                'th': 2,
                'cn': 3
            };
            
            if (langMap[currentLang] !== undefined && langLinks[langMap[currentLang]]) {
                langLinks[langMap[currentLang]].classList.add('active');
            } else {
                // Fallback to English if saved language is not found
                langLinks[0].classList.add('active');
                currentLang = 'en';
                localStorage.setItem('puCalculatorLanguage', 'en');
            }
            
            // Update all translations to the saved language
            updateTranslations();
        }

        // Save form data to localStorage
        function saveFormData() {
            const formData = {
                // Part 1
                lineSpeed: document.getElementById('lineSpeed').value,
                output: document.getElementById('output').value,
                concentration: document.getElementById('concentration').value,
                ratio: document.getElementById('ratio').value,
                // Part 2
                part2_linespeed: document.getElementById('part2_linespeed').value,
                part2_test_time: document.getElementById('part2_test_time').value,
                part2_polyol: document.getElementById('part2_polyol').value,
                part2_iso: document.getElementById('part2_iso').value,
                part2_polyol_rpm: document.getElementById('part2_polyol_rpm').value,
                part2_iso_rpm: document.getElementById('part2_iso_rpm').value,
                // Part 3
                part3_new_linespeed: document.getElementById('part3_new_linespeed').value,
                part3_new_consumption: document.getElementById('part3_new_consumption').value,
                part3_new_ratio: document.getElementById('part3_new_ratio').value,
                // Global settings
                globalAutoClipboard: document.getElementById('globalAutoClipboard').checked
            };
            localStorage.setItem('puCalculatorFormData', JSON.stringify(formData));
        }

        // Restore form data from localStorage
        function restoreFormData() {
            const savedData = localStorage.getItem('puCalculatorFormData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                // Part 1
                document.getElementById('lineSpeed').value = formData.lineSpeed || excelData.initial_values.line_speed;
                document.getElementById('output').value = formData.output || excelData.initial_values.output;
                document.getElementById('concentration').value = formData.concentration || excelData.initial_values.concentration;
                document.getElementById('ratio').value = formData.ratio || excelData.initial_values.ratio;
                // Part 2
                document.getElementById('part2_linespeed').value = formData.part2_linespeed || excelData.part2.linespeed;
                document.getElementById('part2_test_time').value = formData.part2_test_time || excelData.part2.test_time;
                document.getElementById('part2_polyol').value = formData.part2_polyol || excelData.part2.polyol_weight;
                document.getElementById('part2_iso').value = formData.part2_iso || excelData.part2.iso_weight;
                document.getElementById('part2_polyol_rpm').value = formData.part2_polyol_rpm || excelData.part2.polyol_rpm;
                document.getElementById('part2_iso_rpm').value = formData.part2_iso_rpm || excelData.part2.iso_rpm;
                // Part 3
                document.getElementById('part3_new_linespeed').value = formData.part3_new_linespeed || excelData.part3.new_linespeed;
                document.getElementById('part3_new_consumption').value = formData.part3_new_consumption || excelData.part3.new_consumption_gm;
                document.getElementById('part3_new_ratio').value = formData.part3_new_ratio || excelData.part3.new_ratio;
                // Global settings
                document.getElementById('globalAutoClipboard').checked = formData.globalAutoClipboard !== undefined ? formData.globalAutoClipboard : false;
                return true;
            }
            return false;
        }

        // Add auto-save functionality to all input fields
        function addAutoSave() {
            const inputIds = [
                'lineSpeed', 'output', 'concentration', 'ratio'
            ];
            
            inputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', saveFormData);
                }
            });
            
            // Add auto-save for global clipboard toggle
            const globalToggle = document.getElementById('globalAutoClipboard');
            if (globalToggle) {
                globalToggle.addEventListener('change', saveFormData);
            }
        }

        // Initialize with saved data or default values from the Excel file
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize language first
            initializeLanguage();
            
            // Initialize instructions after language is set
            if (typeof initializeInstructions !== 'undefined') {
                initializeInstructions();
            }
            
            // Try to restore saved data, otherwise use defaults
            if (!restoreFormData()) {
                // Initialize Part 1 values
                document.getElementById('lineSpeed').value = excelData.initial_values.line_speed;
                document.getElementById('output').value = excelData.initial_values.output;
                document.getElementById('concentration').value = excelData.initial_values.concentration;
                document.getElementById('ratio').value = excelData.initial_values.ratio;

                // Initialize Part 2 values
                const part2Data = excelData.part2;
                document.getElementById('part2_linespeed').value = part2Data.linespeed;
                document.getElementById('part2_test_time').value = part2Data.test_time;
                document.getElementById('part2_polyol').value = part2Data.polyol_weight;
                document.getElementById('part2_iso').value = part2Data.iso_weight;
                document.getElementById('part2_polyol_rpm').value = part2Data.polyol_rpm;
                document.getElementById('part2_iso_rpm').value = part2Data.iso_rpm;

                // Initialize Part 3 values
                const part3Data = excelData.part3;
                document.getElementById('part3_new_linespeed').value = part3Data.new_linespeed;
                document.getElementById('part3_new_consumption').value = part3Data.new_consumption_gm;
                document.getElementById('part3_new_ratio').value = part3Data.new_ratio;
            }
            
            // Add auto-save listeners to all input fields
            addAutoSave();
            
            // Add input validation
            addInputValidation();
        });
    </script>
</body>
</html>